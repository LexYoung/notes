<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="&amp;nbsp;  &amp;nbsp; 关于温控，高通+Android平台目前主要提供了3个层面的机制来保护设备  硬件相关控制（LMH） Linux内核控制（Thermal Core） User Space控制（ThermalEngine守护进程）  此章节主要介绍Thermal Core的相关内容。">
<meta property="og:type" content="article">
<meta property="og:title" content="Thermal Core 框架">
<meta property="og:url" content="http://example.com/2021/01/05/Thermal_Core_Framework_Architecture/index.html">
<meta property="og:site_name" content="LexYoung笔记">
<meta property="og:description" content="&amp;nbsp;  &amp;nbsp; 关于温控，高通+Android平台目前主要提供了3个层面的机制来保护设备  硬件相关控制（LMH） Linux内核控制（Thermal Core） User Space控制（ThermalEngine守护进程）  此章节主要介绍Thermal Core的相关内容。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2021/01/05/Thermal_Core_Framework_Architecture/Thermal_Core_Framework_Architecture.PNG">
<meta property="og:image" content="http://example.com/2021/01/05/Thermal_Core_Framework_Architecture/step_wise.PNG">
<meta property="og:image" content="http://example.com/2021/01/05/Thermal_Core_Framework_Architecture/Thermal_core.png">
<meta property="article:published_time" content="2021-01-05T12:01:20.000Z">
<meta property="article:modified_time" content="2021-06-28T12:13:50.972Z">
<meta property="article:author" content="LexYoung">
<meta property="article:tag" content="Thermal">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/01/05/Thermal_Core_Framework_Architecture/Thermal_Core_Framework_Architecture.PNG">

<link rel="canonical" href="http://example.com/2021/01/05/Thermal_Core_Framework_Architecture/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Thermal Core 框架 | LexYoung笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">LexYoung笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/05/Thermal_Core_Framework_Architecture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LexYoung">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LexYoung笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Thermal Core 框架
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-01-05 20:01:20" itemprop="dateCreated datePublished" datetime="2021-01-05T20:01:20+08:00">2021-01-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-28 20:13:50" itemprop="dateModified" datetime="2021-06-28T20:13:50+08:00">2021-06-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Thermal/" itemprop="url" rel="index"><span itemprop="name">Thermal</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <!-- toc -->
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<p>关于温控，高通+Android平台目前主要提供了3个层面的机制来保护设备</p>
<ul>
<li>硬件相关控制（LMH）</li>
<li>Linux内核控制（Thermal Core）</li>
<li>User Space控制（ThermalEngine守护进程）</li>
</ul>
<p>此章节主要介绍Thermal Core的相关内容。<br><a id="more"></a><br>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<p>Thermal Core是用来替代之前的legacy framework kernel thermal monitor (KTM)，目前Thermal Core的关键功能如下</p>
<ul>
<li>Core isolation (hotplugging)</li>
<li>GPU Tj management</li>
<li>Low temperature management, that is, VDD restriction</li>
<li>OEM Tskin management (optional)</li>
</ul>
<p>主要框架图如下：<br><img src="/2021/01/05/Thermal_Core_Framework_Architecture/Thermal_Core_Framework_Architecture.PNG" alt="Thermal Core Framework Arch"></p>
<p>从框图中可以看到，整个Thermal Core框架包括4大主要部分：</p>
<ul>
<li>Thermal Zone Device：主要用来获取温度，并设置不同的温度触发点。</li>
<li>Thermal Governor：提供多种算法来控制温度：Step Wise、User Space等。</li>
<li>Thermal Cooling Device：降温设备的抽象，目前Cooling设备可以是CPU、devfreq、clock等。</li>
<li>Thermal Core：作为Thermal框架的中枢，提供核心函数，同时提供用户空间sysfs节点。</li>
</ul>
<p>Thermal Core的工作流程是通过Thermal Zone Device来获取温度并设置不同的温度触发点，经过配置的Thermal Governor来执行不同的策略，最终通过Thermal Cooling Device来控制温度到一个安全且适合的范围内。</p>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h2 id="Thermal-Zone-Device"><a href="#Thermal-Zone-Device" class="headerlink" title="Thermal Zone Device"></a>Thermal Zone Device</h2><p>内核代码使用thermal_zone_device 来抽象Thermal Zone Device，Thermal Zone Device主要作用为获取各个sensor对应的温度，并设置各个sensor的温度触发点.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_device</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">char</span> type[THERMAL_NAME_LENGTH];<span class="comment">//sensor名字</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">device</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> <span class="title">trips_attribute_group</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_attr</span> *<span class="title">trip_temp_attrs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_attr</span> *<span class="title">trip_type_attrs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_attr</span> *<span class="title">trip_hyst_attrs</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *devdata;</span><br><span class="line">	<span class="keyword">int</span> trips;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> trips_disabled;	<span class="comment">/* bitmap for disabled trips */</span></span><br><span class="line">	<span class="keyword">int</span> passive_delay;</span><br><span class="line">	<span class="keyword">int</span> polling_delay;<span class="comment">//轮询读取sensor的时间间隔，0表示取消轮询工作队列</span></span><br><span class="line">	<span class="keyword">int</span> temperature;<span class="comment">//当前温度</span></span><br><span class="line">	<span class="keyword">int</span> last_temperature;<span class="comment">//上次读取的温度</span></span><br><span class="line">	<span class="keyword">int</span> emul_temperature;</span><br><span class="line">	<span class="keyword">int</span> passive;</span><br><span class="line">	<span class="keyword">int</span> prev_low_trip;</span><br><span class="line">	<span class="keyword">int</span> prev_high_trip;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> forced_passive;</span><br><span class="line">	<span class="keyword">atomic_t</span> need_update;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_device_ops</span> *<span class="title">ops</span>;</span><span class="comment">//thermal zone device操作函数集</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_params</span> *<span class="title">tzp</span>;</span><span class="comment">//thermal zone devicee参数</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_governor</span> *<span class="title">governor</span>;</span><span class="comment">//算法相关</span></span><br><span class="line">	<span class="keyword">void</span> *governor_data;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">thermal_instances</span>;</span><span class="comment">//挂载所有thermal策略示例的链表</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ida</span> <span class="title">ida</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span><span class="comment">//挂载thermal zone device的链表</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span> <span class="title">poll_queue</span>;</span><span class="comment">//轮询工作队列</span></span><br><span class="line">	<span class="keyword">enum</span> thermal_notify_event notify_event;<span class="comment">//uevent事件类型，通过userspace算法类型传递给用户空间</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_device_ops</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*bind) (struct thermal_zone_device *,struct thermal_cooling_device *);</span><br><span class="line">	<span class="keyword">int</span> (*unbind) (struct thermal_zone_device *,struct thermal_cooling_device *);</span><br><span class="line">	<span class="keyword">int</span> (*get_temp) (struct thermal_zone_device *, <span class="keyword">int</span> *);</span><br><span class="line">	<span class="keyword">int</span> (*set_trips) (struct thermal_zone_device *, <span class="keyword">int</span>, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*get_mode) (struct thermal_zone_device *,<span class="keyword">enum</span> thermal_device_mode *);</span><br><span class="line">	<span class="keyword">int</span> (*set_mode) (struct thermal_zone_device *,<span class="keyword">enum</span> thermal_device_mode);</span><br><span class="line">	<span class="keyword">int</span> (*get_trip_type) (struct thermal_zone_device *, <span class="keyword">int</span>,<span class="keyword">enum</span> thermal_trip_type *);</span><br><span class="line">	<span class="keyword">int</span> (*get_trip_temp) (struct thermal_zone_device *, <span class="keyword">int</span>, <span class="keyword">int</span> *);</span><br><span class="line">	<span class="keyword">int</span> (*set_trip_temp) (struct thermal_zone_device *, <span class="keyword">int</span>, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*get_trip_hyst) (struct thermal_zone_device *, <span class="keyword">int</span>, <span class="keyword">int</span> *);</span><br><span class="line">	<span class="keyword">int</span> (*set_trip_hyst) (struct thermal_zone_device *, <span class="keyword">int</span>, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*get_crit_temp) (struct thermal_zone_device *, <span class="keyword">int</span> *);</span><br><span class="line">	<span class="keyword">int</span> (*set_emul_temp) (struct thermal_zone_device *, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*get_trend) (struct thermal_zone_device *, <span class="keyword">int</span>,<span class="keyword">enum</span> thermal_trend *);</span><br><span class="line">	<span class="keyword">int</span> (*notify) (struct thermal_zone_device *, <span class="keyword">int</span>,<span class="keyword">enum</span> thermal_trip_type);</span><br><span class="line">	<span class="keyword">bool</span> (*is_wakeable)(struct thermal_zone_device *);</span><br><span class="line">	<span class="keyword">int</span> (*set_polling_delay)(struct thermal_zone_device *, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*set_passive_delay)(struct thermal_zone_device *, <span class="keyword">int</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h2 id="Thermal-Core"><a href="#Thermal-Core" class="headerlink" title="Thermal Core"></a>Thermal Core</h2><p>Thermal Core作为整个框架的中枢，我们先来分析一下thermal_core.c的入口函数。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* kernel/msm-4.14/drivers/thermal/thermal_core.c */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">thermal_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//注册各种算法类型</span></span><br><span class="line">	thermal_register_governors();</span><br><span class="line">    ----&gt;thermal_gov_step_wise_register();</span><br><span class="line">    ----&gt;thermal_gov_fair_share_register();</span><br><span class="line">    ----&gt;thermal_gov_bang_bang_register();</span><br><span class="line">    ----&gt;thermal_gov_user_space_register();</span><br><span class="line">    ----&gt;thermal_gov_low_limits_register();</span><br><span class="line">    ----&gt;thermal_gov_power_allocator_register();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成/sys/class/thermal目录</span></span><br><span class="line">    class_register(&amp;thermal_class);</span><br><span class="line">    <span class="comment">//解析dts，生成thermal zone device,核心函数，下面重点分析</span></span><br><span class="line">    of_parse_thermal_zones();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注册pm回调函数</span></span><br><span class="line">    register_pm_notifier(&amp;thermal_pm_nb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>thermal_init作为设备加载函数，主要作用：</p>
<ul>
<li>注册各种类型的governor机制</li>
<li>生成/sys/class/thermal目录</li>
<li>解析 DTS 中的 Thermal-zones 节点，用于生成/sys/class/thermal/thermal_zone[0-*]节点.</li>
</ul>
<p>一个thermal zone device的DTS示例：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* kernel/msm-4.14/arch/arm64/boot/dts/qcom/trinket-thermal.dtsi */</span></span><br><span class="line"><span class="comment">/* kernel/msm-4.14/arch/arm64/boot/dts/qcom/trinket-thermal-overlay.dtsi */</span></span><br><span class="line">&amp;thermal_zones &#123;</span><br><span class="line">    <span class="comment">/* thermal device zone 的名字 */</span></span><br><span class="line">	cpuss<span class="number">-1</span>-step &#123;</span><br><span class="line">		polling-delay-passive = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">		polling-delay = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">		thermal-governor = <span class="string">&quot;step_wise&quot;</span>;</span><br><span class="line">		thermal-sensors = &lt;&amp;tsens0 <span class="number">7</span>&gt;;</span><br><span class="line">		wake-capable-sensor;</span><br><span class="line">        <span class="comment">/* 设置有哪些温度触发点 */</span></span><br><span class="line">		trips &#123;</span><br><span class="line">			cpu5_7_config: cpu<span class="number">-5</span><span class="number">-7</span>-config &#123;</span><br><span class="line">				temperature = &lt;<span class="number">110000</span>&gt;;</span><br><span class="line">				hysteresis = &lt;<span class="number">10000</span>&gt;;</span><br><span class="line">				type = <span class="string">&quot;passive&quot;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">        <span class="comment">/* 把cooling devices与温度触发点绑定 */</span></span><br><span class="line">		cooling-maps &#123;</span><br><span class="line">			cpu5_cdev &#123;</span><br><span class="line">				trip = &lt;&amp;cpu5_7_config&gt;;</span><br><span class="line">				cooling-device =</span><br><span class="line">					&lt;&amp;CPU5 THERMAL_MAX_LIMIT</span><br><span class="line">						THERMAL_MAX_LIMIT&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">			cpu7_cdev &#123;</span><br><span class="line">				trip = &lt;&amp;cpu5_7_config&gt;;</span><br><span class="line">				cooling-device =</span><br><span class="line">					&lt;&amp;CPU7 THERMAL_MAX_LIMIT</span><br><span class="line">						THERMAL_MAX_LIMIT&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>接下来以上面的DTS为例，分析 of_parse_thermal_zones 函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">of_parse_thermal_zones</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span>, *<span class="title">child</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> __<span class="title">thermal_zone</span> *<span class="title">tz</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_device_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 解析dts thermal-zones节点中所有数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	np = of_find_node_by_name(<span class="literal">NULL</span>, <span class="string">&quot;thermal-zones&quot;</span>);</span><br><span class="line"></span><br><span class="line">	for_each_available_child_of_node(np, child) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_device</span> *<span class="title">zone</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_params</span> *<span class="title">tzp</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 解析dts thermal-zones的child的节点cpuss-1-step</span></span><br><span class="line"><span class="comment">         * 这里主要解析polling-delay-passive,polling-delay,trips和cooling-maps属性</span></span><br><span class="line"><span class="comment">         * 最后会把解析的结构通过__thermal_zone结构体return出来。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">		tz = thermal_of_build_thermal_zone(child);</span><br><span class="line">        ---&gt;thermal_of_build_thermal_zone</span><br><span class="line">        ---&gt;for_each_child_of_node(child, gchild) &#123;</span><br><span class="line">                    thermal_of_populate_trip(gchild, &amp;tz-&gt;trips[i++]);</span><br><span class="line">                    </span><br><span class="line">        ---&gt;child = of_get_child_by_name(np, <span class="string">&quot;cooling-maps&quot;</span>);</span><br><span class="line">        ---&gt;for_each_child_of_node(child, gchild) &#123;</span><br><span class="line">                    thermal_of_populate_bind_params(gchild, &amp;tz-&gt;tbps[i++],</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 初始化tzp结构体，并使用DTS的属性进行填充，主要包括&quot;thermal-governor&quot;属性等</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">		tzp = kzalloc(<span class="keyword">sizeof</span>(*tzp), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 使用上面从DTS解析的数据，注册一个thermal zone devices</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">		zone = thermal_zone_device_register(child-&gt;name, tz-&gt;ntrips,</span><br><span class="line">						    mask, tz,</span><br><span class="line">						    ops, tzp,</span><br><span class="line">						    tz-&gt;passive_delay,</span><br><span class="line">						    tz-&gt;polling_delay);</span><br><span class="line">		tz-&gt;tzd = zone;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>接下来重点分析注册tehrmal zone devices的函数 thermal_zone_device_register。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">thermal_zone_device_register(<span class="keyword">const</span> <span class="keyword">char</span> *type, <span class="keyword">int</span> trips, <span class="keyword">int</span> mask,</span><br><span class="line">			     <span class="keyword">void</span> *devdata, struct thermal_zone_device_ops *ops,</span><br><span class="line">			     struct thermal_zone_params *tzp, <span class="keyword">int</span> passive_delay,</span><br><span class="line">			     <span class="keyword">int</span> polling_delay)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_device</span> *<span class="title">tz</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_governor</span> *<span class="title">governor</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 初始化thermal_instances链表，thermal_instances变量为一个具体的实例策略。</span></span><br><span class="line"><span class="comment"> 	 * This structure(thermal_instances) is used to </span></span><br><span class="line"><span class="comment"> 	 * describe the behavior of a certain cooling device </span></span><br><span class="line"><span class="comment">	 * on a certain trip point in a certain thermal zone</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	INIT_LIST_HEAD(&amp;tz-&gt;thermal_instances);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 对thermal_zone_device *tz变量进行赋值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	tz-&gt;id = result;</span><br><span class="line">	strlcpy(tz-&gt;type, type, <span class="keyword">sizeof</span>(tz-&gt;type));</span><br><span class="line">	tz-&gt;ops = ops;</span><br><span class="line">	tz-&gt;tzp = tzp;</span><br><span class="line">	tz-&gt;device.class = &amp;thermal_class;</span><br><span class="line">	tz-&gt;devdata = devdata;</span><br><span class="line">	tz-&gt;trips = trips;</span><br><span class="line">	tz-&gt;passive_delay = passive_delay;</span><br><span class="line">	tz-&gt;polling_delay = polling_delay;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* sys I/F */</span></span><br><span class="line">	<span class="comment">/* Add nodes that are always present via .groups */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 把各种attribute_group结构体变量赋值给tz-&gt;device.groups</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	thermal_zone_create_device_groups(tz, mask);</span><br><span class="line">    ----&gt;<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size - <span class="number">2</span>; i++)</span><br><span class="line">            groups[i] = thermal_zone_attribute_groups[i];</span><br><span class="line">    ---&gt;<span class="keyword">if</span> (tz-&gt;trips) &#123;</span><br><span class="line">            result = create_trip_attrs(tz, mask);</span><br><span class="line">            <span class="keyword">if</span> (result) &#123;</span><br><span class="line">                kfree(groups);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            groups[size - <span class="number">2</span>] = &amp;tz-&gt;trips_attribute_group;</span><br><span class="line">        &#125;</span><br><span class="line">	---&gt;tz-&gt;device.groups = groups;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 设置新的thermal zone*名字，</span></span><br><span class="line"><span class="comment">	 * 并根据上面的tz-&gt;device.groups创建/sys/class/thermal/thermal_zoneN 下面的各个属性节点</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	dev_set_name(&amp;tz-&gt;device, <span class="string">&quot;thermal_zone%d&quot;</span>, tz-&gt;id);</span><br><span class="line">	device_register(&amp;tz-&gt;device);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 为thermal zoneN设置新的governor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    thermal_set_governor(tz, governor);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 把该thermal_zone_device结构体添加到链表thermal_tz_list中</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	list_add_tail(&amp;tz-&gt;node, &amp;thermal_tz_list);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Bind cooling devices for this zone */</span></span><br><span class="line">	bind_tz(tz);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 初始化poll_queue工作队列，对应的function主要用来轮询检测thermal zone device是否触发温度</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	INIT_DEFERRABLE_WORK(&amp;(tz-&gt;poll_queue), thermal_zone_device_check);</span><br><span class="line">	---&gt;thermal_zone_device_update(tz, THERMAL_EVENT_UNSPECIFIED);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 主要工作为对thermal_instance实例中的initialized变量赋为false.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	thermal_zone_device_reset(tz);</span><br><span class="line">	---&gt;thermal_zone_device_init(tz);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Update the new thermal zone and mark it as already updated. */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 1.更新thermal device zone对应的温度</span></span><br><span class="line"><span class="comment">	 * 2.设置触发温度</span></span><br><span class="line"><span class="comment">	 * 3.处理温度触发情况</span></span><br><span class="line"><span class="comment">	 * ---&gt;a.如果为critical类型，到达触发温度，执行关机/重启操作</span></span><br><span class="line"><span class="comment">	 * ---&gt;b.如果非critical类型，到达触发温度，执行对应的governor算法操作</span></span><br><span class="line"><span class="comment">	 * ---&gt;c.延时启动poll_queue工作队列，再次调用thermal_zone_device_update函数。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (atomic_cmpxchg(&amp;tz-&gt;need_update, <span class="number">1</span>, <span class="number">0</span>))</span><br><span class="line">		thermal_zone_device_update(tz, THERMAL_EVENT_UNSPECIFIED);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> tz;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(thermal_zone_device_register);</span><br></pre></td></tr></table></figure><br>接来下我们重点解析 bind_tz 和 thermal_zone_device_update 函数,首先分析bind_tz函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bind_tz</span><span class="params">(struct thermal_zone_device *tz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_cooling_device</span> *<span class="title">pos</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_params</span> *<span class="title">tzp</span> = <span class="title">tz</span>-&gt;<span class="title">tzp</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If there is ops-&gt;bind, try to use ops-&gt;bind */</span></span><br><span class="line">	<span class="keyword">if</span> (tz-&gt;ops-&gt;bind) &#123;</span><br><span class="line">		list_for_each_entry(pos, &amp;thermal_cdev_list, node) &#123;</span><br><span class="line">			ret = tz-&gt;ops-&gt;bind(tz, pos);</span><br><span class="line">			---&gt;of_thermal_bind</span><br><span class="line">                ---&gt; thermal_zone_bind_cooling_device(thermal,</span><br><span class="line">												tbp-&gt;trip_id, cdev,</span><br><span class="line">												tbp-&gt;max,</span><br><span class="line">												tbp-&gt;min,</span><br><span class="line">												tbp-&gt;usage);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * thermal_zone_bind_cooling_device() - bind a cooling device to a thermal zone</span></span><br><span class="line"><span class="comment"> * @tz:		pointer to struct thermal_zone_device</span></span><br><span class="line"><span class="comment"> * @trip:	indicates which trip point the cooling devices is</span></span><br><span class="line"><span class="comment"> *		associated with in this thermal zone.</span></span><br><span class="line"><span class="comment"> * @cdev:	pointer to struct thermal_cooling_device</span></span><br><span class="line"><span class="comment"> * @upper:	the Maximum cooling state for this trip point.</span></span><br><span class="line"><span class="comment"> *		THERMAL_NO_LIMIT means no upper limit,</span></span><br><span class="line"><span class="comment"> *		and the cooling device can be in max_state.</span></span><br><span class="line"><span class="comment"> * @lower:	the Minimum cooling state can be used for this trip point.</span></span><br><span class="line"><span class="comment"> *		THERMAL_NO_LIMIT means no lower limit,</span></span><br><span class="line"><span class="comment"> *		and the cooling device can be in cooling state 0.</span></span><br><span class="line"><span class="comment"> * @weight:	The weight of the cooling device to be bound to the</span></span><br><span class="line"><span class="comment"> *		thermal zone. Use THERMAL_WEIGHT_DEFAULT for the</span></span><br><span class="line"><span class="comment"> *		default value</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This interface function bind a thermal cooling device to the certain trip</span></span><br><span class="line"><span class="comment"> * point of a thermal zone device.</span></span><br><span class="line"><span class="comment"> * This function is usually called in the thermal zone device .bind callback.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: 0 on success, the proper error value otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">thermal_zone_bind_cooling_device</span><span class="params">(struct thermal_zone_device *tz,</span></span></span><br><span class="line"><span class="function"><span class="params">				     <span class="keyword">int</span> trip,</span></span></span><br><span class="line"><span class="function"><span class="params">				     struct thermal_cooling_device *cdev,</span></span></span><br><span class="line"><span class="function"><span class="params">				     <span class="keyword">unsigned</span> <span class="keyword">long</span> upper, <span class="keyword">unsigned</span> <span class="keyword">long</span> lower,</span></span></span><br><span class="line"><span class="function"><span class="params">				     <span class="keyword">unsigned</span> <span class="keyword">int</span> weight)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_instance</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_instance</span> *<span class="title">pos</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_device</span> *<span class="title">pos1</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_cooling_device</span> *<span class="title">pos2</span>;</span></span><br><span class="line"></span><br><span class="line">	dev = kzalloc(<span class="keyword">sizeof</span>(*dev), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!dev)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	dev-&gt;tz = tz;</span><br><span class="line">	dev-&gt;cdev = cdev;</span><br><span class="line">	dev-&gt;trip = trip;</span><br><span class="line">	dev-&gt;upper = upper;</span><br><span class="line">	dev-&gt;lower = lower;</span><br><span class="line">	dev-&gt;target = THERMAL_NO_TARGET;</span><br><span class="line">	dev-&gt;weight = weight;</span><br><span class="line"></span><br><span class="line">	result = ida_simple_get(&amp;tz-&gt;ida, <span class="number">0</span>, <span class="number">0</span>, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (result &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> free_mem;</span><br><span class="line"></span><br><span class="line">	dev-&gt;id = result;</span><br><span class="line">	<span class="built_in">sprintf</span>(dev-&gt;name, <span class="string">&quot;cdev%d&quot;</span>, dev-&gt;id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * 暴露属性节点，并赋值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="built_in">sprintf</span>(dev-&gt;attr_name, <span class="string">&quot;cdev%d_trip_point&quot;</span>, dev-&gt;id);</span><br><span class="line">	sysfs_attr_init(&amp;dev-&gt;attr.attr);</span><br><span class="line">	dev-&gt;attr.attr.name = dev-&gt;attr_name;</span><br><span class="line">	dev-&gt;attr.attr.mode = <span class="number">0444</span>;</span><br><span class="line">	dev-&gt;attr.show = thermal_cooling_device_trip_point_show;</span><br><span class="line">	result = device_create_file(&amp;tz-&gt;device, &amp;dev-&gt;attr);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">snprintf</span>(dev-&gt;upper_attr_name, THERMAL_NAME_LENGTH,</span><br><span class="line">			<span class="string">&quot;cdev%d_upper_limit&quot;</span>, dev-&gt;id);</span><br><span class="line">	sysfs_attr_init(&amp;dev-&gt;upper_attr.attr);</span><br><span class="line">	dev-&gt;upper_attr.attr.name = dev-&gt;upper_attr_name;</span><br><span class="line">	dev-&gt;upper_attr.attr.mode = <span class="number">0644</span>;</span><br><span class="line">	dev-&gt;upper_attr.show = thermal_cooling_device_upper_limit_show;</span><br><span class="line">	dev-&gt;upper_attr.store = thermal_cooling_device_upper_limit_store;</span><br><span class="line">	result = device_create_file(&amp;tz-&gt;device, &amp;dev-&gt;upper_attr);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">snprintf</span>(dev-&gt;lower_attr_name, THERMAL_NAME_LENGTH,</span><br><span class="line">			<span class="string">&quot;cdev%d_lower_limit&quot;</span>, dev-&gt;id);</span><br><span class="line">	sysfs_attr_init(&amp;dev-&gt;lower_attr.attr);</span><br><span class="line">	dev-&gt;lower_attr.attr.name = dev-&gt;lower_attr_name;</span><br><span class="line">	dev-&gt;lower_attr.attr.mode = <span class="number">0644</span>;</span><br><span class="line">	dev-&gt;lower_attr.show = thermal_cooling_device_lower_limit_show;</span><br><span class="line">	dev-&gt;lower_attr.store = thermal_cooling_device_lower_limit_store;</span><br><span class="line">	result = device_create_file(&amp;tz-&gt;device, &amp;dev-&gt;lower_attr);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">sprintf</span>(dev-&gt;weight_attr_name, <span class="string">&quot;cdev%d_weight&quot;</span>, dev-&gt;id);</span><br><span class="line">	sysfs_attr_init(&amp;dev-&gt;weight_attr.attr);</span><br><span class="line">	dev-&gt;weight_attr.attr.name = dev-&gt;weight_attr_name;</span><br><span class="line">	dev-&gt;weight_attr.attr.mode = S_IWUSR | S_IRUGO;</span><br><span class="line">	dev-&gt;weight_attr.show = thermal_cooling_device_weight_show;</span><br><span class="line">	dev-&gt;weight_attr.store = thermal_cooling_device_weight_store;</span><br><span class="line">	result = device_create_file(&amp;tz-&gt;device, &amp;dev-&gt;weight_attr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * 把 thermal zone device 和对应的 thermal cooling device 添加到thermal_instances中</span></span><br><span class="line"><span class="comment">     * 即绑定操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="keyword">if</span> (!result) &#123;</span><br><span class="line">		list_add_tail(&amp;dev-&gt;tz_node, &amp;tz-&gt;thermal_instances);</span><br><span class="line">		list_add_tail(&amp;dev-&gt;cdev_node, &amp;cdev-&gt;thermal_instances);</span><br><span class="line">		atomic_set(&amp;tz-&gt;need_update, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(thermal_zone_bind_cooling_device);</span><br></pre></td></tr></table></figure><br>然后分析 thermal_zone_device_update 函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">thermal_zone_device_update</span><span class="params">(struct thermal_zone_device *tz,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">enum</span> thermal_notify_event event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 获取对应thermal zone device最新的温度</span></span><br><span class="line"><span class="comment">	 * 并存储上次的温度值</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	update_temperature(tz);</span><br><span class="line">	---&gt;thermal_zone_get_temp(tz, &amp;temp);</span><br><span class="line">	---&gt;store_temperature(tz, temp);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 设置触发温度</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	thermal_zone_set_trips(tz);</span><br><span class="line"></span><br><span class="line">	tz-&gt;notify_event = event;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (count = <span class="number">0</span>; count &lt; tz-&gt;trips; count++)</span><br><span class="line">		handle_thermal_trip(tz, count);</span><br><span class="line">    	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * 根据触发类型，执行对应的函数处理函数</span></span><br><span class="line"><span class="comment">		 * critical类型对应关机/重启</span></span><br><span class="line"><span class="comment">		 * non_critical类型对应设置的governor</span></span><br><span class="line"><span class="comment">		 */</span> </span><br><span class="line">		---&gt;handle_critical_trips(tz, trip, type);</span><br><span class="line">		<span class="keyword">or</span></span><br><span class="line">		---&gt;handle_non_critical_trips(tz, trip, type);</span><br><span class="line">		</span><br><span class="line">		---&gt;monitor_thermal_zone(tz);</span><br><span class="line">			---&gt;thermal_zone_device_set_polling</span><br><span class="line">				---&gt;延时调用poll_queue工作队列，再次执行thermal_zone_device_update</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(thermal_zone_device_update);</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>代码流程总结：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">thermal_init</span><br><span class="line"><span class="comment">//解析dts中的thermal zone节点，并利用解析出来的数据注册thermal zone device</span></span><br><span class="line">---&gt;of_parse_thermal_zones</span><br><span class="line">	<span class="comment">//注册thermal zone device</span></span><br><span class="line">	---&gt;thermal_zone_device_register</span><br><span class="line">		---&gt;<span class="number">1.</span>创建thermal_zoneN下面的属性节点</span><br><span class="line">		---&gt;<span class="number">2.</span>为thermal_zoneN设置新的governor</span><br><span class="line">		---&gt;<span class="number">3.</span>把该thermal_zone_device结构体添加到链表thermal_tz_list中</span><br><span class="line">		---&gt;<span class="number">4.</span>把thermal zone device 和对应的thermal cooling device进行绑定</span><br><span class="line">		---&gt;<span class="number">5.</span>初始化poll_queue工作队列</span><br><span class="line">		---&gt;<span class="number">6.</span>周期性调度工作队列poll_queue，主要作用如下</span><br><span class="line">			---&gt;a.获取thermal device zone对应的温度</span><br><span class="line">			---&gt;b.设置触发温度</span><br><span class="line">			---&gt;c.处理温度触发情况</span><br><span class="line">				---&gt;(<span class="number">1</span>).如果为critical类型，到达触发温度，执行关机/重启操作</span><br><span class="line">				---&gt;(<span class="number">2</span>).如果非critical类型，到达触发温度，执行对应的governor算法操作</span><br><span class="line">				---&gt;(<span class="number">3</span>).延时启动poll_queue工作队列，再次调用thermal_zone_device_update函数。</span><br></pre></td></tr></table></figure></p>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h2 id="Thermal-Cooling-Device"><a href="#Thermal-Cooling-Device" class="headerlink" title="Thermal Cooling Device"></a>Thermal Cooling Device</h2><p>Thermal Cooling Device 为降温设备，可用的降温设备大致如下</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Cooling device</th>
<th>Ation</th>
</tr>
</thead>
<tbody>
<tr>
<td>CPU</td>
<td>CPU frequency throttling, core isolation is last mitigation level</td>
</tr>
<tr>
<td>GPU(devfreq)</td>
<td>GPU frequency throttling</td>
</tr>
<tr>
<td>Battery</td>
<td>Charge rate throttling</td>
</tr>
<tr>
<td>Regulator</td>
<td>Increase of voltage on CPU rail</td>
</tr>
<tr>
<td>Backlight</td>
<td>Display backlight throttling</td>
</tr>
<tr>
<td>Modem</td>
<td>Adjustment of peak data rates, maximum Tx power</td>
</tr>
<tr>
<td>AOP</td>
<td>Voltage restriction on CX/EBI with RPMh architecture</td>
</tr>
</tbody>
</table>
</div>
<p>它们在内核中抽象为thermal_cooling_device结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thermal_cooling_device</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">char</span> type[THERMAL_NAME_LENGTH];<span class="comment">//cooling device name</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">device</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *devdata;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">thermal_cooling_device_ops</span> *<span class="title">ops</span>;</span><span class="comment">//操作函数集</span></span><br><span class="line">	<span class="keyword">bool</span> updated; <span class="comment">/* true if the cooling device does not need update */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span> <span class="comment">/* protect thermal_instances list */</span></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * 挂载所有thermal策略示例的链表，</span></span><br><span class="line"><span class="comment">     * 一个thermal_instances一般正常包含一个thermal zone device，一个cooling device</span></span><br><span class="line"><span class="comment">     * 和对应的触发温度，以及对应的触发措施。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">thermal_instances</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span><span class="comment">//挂载thermal cooling device的链表</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> sysfs_cur_state_req;<span class="comment">//当前等级请求</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> sysfs_min_state_req;<span class="comment">//最小等级请求</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里以 backlight 和 cpu 实例分析一下thermal cooling devices的整个使用流程。</p>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h3 id="backlight示例"><a href="#backlight示例" class="headerlink" title="backlight示例"></a>backlight示例</h3><p>首先framebuff驱动中，会调用 backlight_device_register 来注册背光驱动，在其中会调用 backlight_cdev_register 来注册backlight cooling devices，所以我们来分析一下在其中 backlight_cdev_register 的调用流程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">kernel/msm<span class="number">-4.14</span>/drivers/video/backlight/backlight.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">backlight_cdev_register</span><span class="params">(struct device *parent,</span></span></span><br><span class="line"><span class="function"><span class="params">				    struct backlight_device *bd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (of_find_property(parent-&gt;of_node, <span class="string">&quot;#cooling-cells&quot;</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">		bd-&gt;cdev = thermal_of_cooling_device_register(parent-&gt;of_node,</span><br><span class="line">				(<span class="keyword">char</span> *)dev_name(&amp;bd-&gt;dev), bd, &amp;bd_cdev_ops);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">thermal_of_cooling_device_register(struct device_node *np,</span><br><span class="line">				   <span class="keyword">char</span> *type, <span class="keyword">void</span> *devdata,</span><br><span class="line">				   <span class="keyword">const</span> struct thermal_cooling_device_ops *ops)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> __thermal_cooling_device_register(np, type, devdata, ops);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __thermal_cooling_device_register() - register a new thermal cooling device</span></span><br><span class="line"><span class="comment"> * @np:		a pointer to a device tree node.</span></span><br><span class="line"><span class="comment"> * @type:	the thermal cooling device type.</span></span><br><span class="line"><span class="comment"> * @devdata:	device private data.</span></span><br><span class="line"><span class="comment"> * @ops:		standard thermal cooling devices callbacks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This interface function adds a new thermal cooling device (fan/processor/...)</span></span><br><span class="line"><span class="comment"> * to /sys/class/thermal/ folder as cooling_device[0-*]. It tries to bind itself</span></span><br><span class="line"><span class="comment"> * to all the thermal zone devices registered at the same time.</span></span><br><span class="line"><span class="comment"> * It also gives the opportunity to link the cooling device to a device tree</span></span><br><span class="line"><span class="comment"> * node, so that it can be bound to a thermal zone created out of device tree.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: a pointer to the created struct thermal_cooling_device or an</span></span><br><span class="line"><span class="comment"> * ERR_PTR. Caller must check return value with IS_ERR*() helpers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">thermal_cooling_device</span> *</span></span><br><span class="line"><span class="class">__<span class="title">thermal_cooling_device_register</span>(<span class="title">struct</span> <span class="title">device_node</span> *<span class="title">np</span>,</span></span><br><span class="line"><span class="class">				  <span class="title">char</span> *<span class="title">type</span>, <span class="title">void</span> *<span class="title">devdata</span>,</span></span><br><span class="line"><span class="class">				  <span class="title">const</span> <span class="title">struct</span> <span class="title">thermal_cooling_device_ops</span> *<span class="title">ops</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_cooling_device</span> *<span class="title">cdev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_zone_device</span> *<span class="title">pos</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">	INIT_LIST_HEAD(&amp;cdev-&gt;thermal_instances);</span><br><span class="line">	</span><br><span class="line">	cdev-&gt;np = np;</span><br><span class="line">	cdev-&gt;ops = ops;</span><br><span class="line">	cdev-&gt;updated = <span class="literal">false</span>;</span><br><span class="line">	cdev-&gt;device.class = &amp;thermal_class;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 设置thermal cooling devcie使用到的属性</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	thermal_cooling_device_setup_sysfs(cdev);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 生成sys/class/thermal/cooling_deviceN/节点和里面的属性，主要属性如下</span></span><br><span class="line"><span class="comment">	 * 关于其中的属性函数设置，在对应的cooling_device驱动中，这里backlight驱动路径为</span></span><br><span class="line"><span class="comment">	 * kernel/msm-4.14/drivers/video/backlight/backlight.c</span></span><br><span class="line"><span class="comment">	 * static struct attribute *cooling_device_attrs[] = &#123;</span></span><br><span class="line"><span class="comment">	 *	&amp;dev_attr_cdev_type.attr,</span></span><br><span class="line"><span class="comment">	 * 	&amp;dev_attr_max_state.attr,</span></span><br><span class="line"><span class="comment">	 * 	&amp;dev_attr_cur_state.attr,</span></span><br><span class="line"><span class="comment">	 * 	&amp;dev_attr_min_state.attr,</span></span><br><span class="line"><span class="comment">	 *  NULL,</span></span><br><span class="line"><span class="comment">	 * 	&#125;;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	dev_set_name(&amp;cdev-&gt;device, <span class="string">&quot;cooling_device%d&quot;</span>, cdev-&gt;id);</span><br><span class="line">	device_register(&amp;cdev-&gt;device);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Add &#x27;this&#x27; new cdev to the global cdev list */</span></span><br><span class="line">	list_add(&amp;cdev-&gt;node, &amp;thermal_cdev_list);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Update binding information for &#x27;this&#x27; new cdev */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 和bind_tz(tz)类似，主要功能是把thermal zone device</span></span><br><span class="line"><span class="comment">	 * 和对应的thermal cooling device联系起来</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	bind_cdev(cdev);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Update binding information for &#x27;this&#x27; new cdev */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 如果在注册thermal zone device中已经执行poll_queue工作队列</span></span><br><span class="line"><span class="comment">	 * 这里就直接跳过，否则调用poll_queue工作队列</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	list_for_each_entry(pos, &amp;thermal_tz_list, node)</span><br><span class="line">		<span class="keyword">if</span> (atomic_cmpxchg(&amp;pos-&gt;need_update, <span class="number">1</span>, <span class="number">0</span>))</span><br><span class="line">			thermal_zone_device_update(pos,</span><br><span class="line">						   THERMAL_EVENT_UNSPECIFIED);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cdev;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">关于 thermal cooling device 的具体函数操作集如下，当thermal-engine通过调用sys/<span class="class"><span class="keyword">class</span>/<span class="title">thermal</span>/<span class="title">cooling_device</span>*/下面的属性节点来调节背光亮度时，具体就会调用对应的函数去实现。</span></span><br><span class="line"><span class="class"><span class="title">static</span> <span class="title">struct</span> <span class="title">thermal_cooling_device_ops</span> <span class="title">bd_cdev_ops</span> = &#123;</span></span><br><span class="line">	.get_max_state = bd_cdev_get_max_brightness,</span><br><span class="line">	.get_cur_state = bd_cdev_get_cur_brightness,</span><br><span class="line">	.set_cur_state = bd_cdev_set_cur_brightness,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>总结：<br>thermal cooling device注册流程比较简单，大致如下：</p>
<ol>
<li>生成 “sys/class/thermal/cooling_deviceN/“ 节点和里面的属性（get_max_state，get_cur_state，set_cur_state）</li>
<li>把cdev node添加到 thermal_cdev_list 链表中</li>
<li>把thermal zone device 和thermal cooling device绑定起来</li>
<li>如果在注册thermal zone device时，已经启动poll_queue工作队列，这里就不调用，否则调用poll_queue工作队列来检测温度，执行对应动作。</li>
</ol>
<p>当温度到达某个 thermal_instances 中thermal zone device对应的触发温度，该触发温度如果绑定的thermal cooling device 为backlight，则调用backlight中的set_cur_state函数设置背光为对应的级别。</p>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h3 id="cpufreq示例"><a href="#cpufreq示例" class="headerlink" title="cpufreq示例"></a>cpufreq示例</h3><p>首先分析cpufreq注册为thermal cooling device的软件流程,主要是通过在 qcom-cpufreq.c 中的 msm_cpufreq_ready函数调用of_cpufreq_cooling_register来完成的，所以我们来分析核心函数of_cpufreq_cooling_register。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * of_cpufreq_cooling_register - function to create cpufreq cooling device.</span></span><br><span class="line"><span class="comment"> * @np: a valid struct device_node to the cooling device device tree node</span></span><br><span class="line"><span class="comment"> * @policy: cpufreq policy</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This interface function registers the cpufreq cooling device with the name</span></span><br><span class="line"><span class="comment"> * &quot;thermal-cpufreq-%x&quot;. This api can support multiple instances of cpufreq</span></span><br><span class="line"><span class="comment"> * cooling devices. Using this API, the cpufreq cooling device will be</span></span><br><span class="line"><span class="comment"> * linked to the device tree node provided.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: a valid struct thermal_cooling_device pointer on success,</span></span><br><span class="line"><span class="comment"> * on failure, it returns a corresponding ERR_PTR().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thermal_cooling_device</span> *</span></span><br><span class="line"><span class="class"><span class="title">of_cpufreq_cooling_register</span>(<span class="title">struct</span> <span class="title">device_node</span> *<span class="title">np</span>,</span></span><br><span class="line"><span class="class">			    <span class="title">struct</span> <span class="title">cpufreq_policy</span> *<span class="title">policy</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">if</span> (!np)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> __cpufreq_cooling_register(np, policy, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __cpufreq_cooling_register - helper function to create cpufreq cooling device</span></span><br><span class="line"><span class="comment"> * @np: a valid struct device_node to the cooling device device tree node</span></span><br><span class="line"><span class="comment"> * @policy: cpufreq policy</span></span><br><span class="line"><span class="comment"> * Normally this should be same as cpufreq policy-&gt;related_cpus.</span></span><br><span class="line"><span class="comment"> * @capacitance: dynamic power coefficient for these cpus</span></span><br><span class="line"><span class="comment"> * @plat_static_func: function to calculate the static power consumed by these</span></span><br><span class="line"><span class="comment"> *                    cpus (optional)</span></span><br><span class="line"><span class="comment"> * @plat_mitig_func: function that does the mitigation by changing the</span></span><br><span class="line"><span class="comment"> *                   frequencies (Optional). By default, cpufreq framework will</span></span><br><span class="line"><span class="comment"> *                   be notified of the new limits.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This interface function registers the cpufreq cooling device with the name</span></span><br><span class="line"><span class="comment"> * &quot;thermal-cpufreq-%x&quot;. This api can support multiple instances of cpufreq</span></span><br><span class="line"><span class="comment"> * cooling devices. It also gives the opportunity to link the cooling device</span></span><br><span class="line"><span class="comment"> * with a device tree node, in order to bind it via the thermal DT code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: a valid struct thermal_cooling_device pointer on success,</span></span><br><span class="line"><span class="comment"> * on failure, it returns a corresponding ERR_PTR().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * of_cpufreq_cooling_register调用__cpufreq_cooling_register时</span></span><br><span class="line"><span class="comment"> * 传入的后3个参数分别为0,NULL,NULL</span></span><br><span class="line"><span class="comment"> * 即capacitance = 0,plat_static_func和plat_ops为NULL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">thermal_cooling_device</span> *</span></span><br><span class="line"><span class="class">__<span class="title">cpufreq_cooling_register</span>(<span class="title">struct</span> <span class="title">device_node</span> *<span class="title">np</span>,</span></span><br><span class="line"><span class="class">			<span class="title">struct</span> <span class="title">cpufreq_policy</span> *<span class="title">policy</span>, <span class="title">u32</span> <span class="title">capacitance</span>,</span></span><br><span class="line"><span class="class">			<span class="title">get_static_t</span> <span class="title">plat_static_func</span>,</span></span><br><span class="line"><span class="class">			<span class="title">struct</span> <span class="title">cpu_cooling_ops</span> *<span class="title">plat_ops</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_cooling_device</span> *<span class="title">cdev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cpufreq_cooling_device</span> *<span class="title">cpufreq_cdev</span>;</span></span><br><span class="line">	<span class="keyword">char</span> dev_name[THERMAL_NAME_LENGTH];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> freq, i, num_cpus, cpu_idx;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_cooling_device_ops</span> *<span class="title">cooling_ops</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> first;</span><br><span class="line">    </span><br><span class="line">	cpufreq_cdev = kzalloc(<span class="keyword">sizeof</span>(*cpufreq_cdev), GFP_KERNEL);</span><br><span class="line">	</span><br><span class="line">	cpufreq_cdev-&gt;policy = policy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 从dts中解析出cpu_idx赋值给cpu_id. */</span></span><br><span class="line">	cpufreq_cdev-&gt;cpu_id = <span class="number">-1</span>;</span><br><span class="line">	for_each_cpu(cpu_idx, policy-&gt;related_cpus) &#123;</span><br><span class="line">		<span class="keyword">if</span> (np == of_cpu_device_node_get(cpu_idx)) &#123;</span><br><span class="line">			cpufreq_cdev-&gt;cpu_id = cpu_idx;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Last level will indicate the core will be isolated. */</span></span><br><span class="line">	cpufreq_cdev-&gt;max_level = i + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	cpufreq_cdev-&gt;freq_table = kmalloc_array(cpufreq_cdev-&gt;max_level,</span><br><span class="line">					<span class="keyword">sizeof</span>(*cpufreq_cdev-&gt;freq_table),</span><br><span class="line">					GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* max_level is an index */</span></span><br><span class="line">	cpufreq_cdev-&gt;max_level--;</span><br><span class="line"></span><br><span class="line">	ret = ida_simple_get(&amp;cpufreq_ida, <span class="number">0</span>, <span class="number">0</span>, GFP_KERNEL);</span><br><span class="line">	cpufreq_cdev-&gt;id = ret;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">snprintf</span>(dev_name, <span class="keyword">sizeof</span>(dev_name), <span class="string">&quot;thermal-cpufreq-%d&quot;</span>,</span><br><span class="line">		 cpufreq_cdev-&gt;id);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fill freq-table in descending order of frequencies */</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>, freq = <span class="number">-1</span>; i &lt; cpufreq_cdev-&gt;max_level; i++) &#123;</span><br><span class="line">		freq = find_next_max(policy-&gt;freq_table, freq);</span><br><span class="line">		cpufreq_cdev-&gt;freq_table[i].frequency = freq;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Max level index is for core isolation, set this level as zero */</span></span><br><span class="line">	cpufreq_cdev-&gt;freq_table[cpufreq_cdev-&gt;max_level].frequency = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * cpu cooling device的操作函数集如下</span></span><br><span class="line"><span class="comment">	 * static struct thermal_cooling_device_ops cpufreq_cooling_ops = &#123;</span></span><br><span class="line"><span class="comment">	 * .get_max_state = cpufreq_get_max_state,</span></span><br><span class="line"><span class="comment">	 * .get_cur_state = cpufreq_get_cur_state,</span></span><br><span class="line"><span class="comment">	 * .set_cur_state = cpufreq_set_cur_state,</span></span><br><span class="line"><span class="comment">	 * .set_min_state = cpufreq_set_min_state,</span></span><br><span class="line"><span class="comment">	 * .get_min_state = cpufreq_get_min_state,</span></span><br><span class="line"><span class="comment">	 * &#125;;</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	cooling_ops = &amp;cpufreq_cooling_ops;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * thermal core提供的统一API，填充相关参数，用来注册thermal cooling devces</span></span><br><span class="line"><span class="comment">	 * 在backlight示例中已分析此函数</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	cdev = thermal_of_cooling_device_register(np, dev_name, cpufreq_cdev,cooling_ops);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 给clipped_freq赋值freq_table中最大的频率</span></span><br><span class="line"><span class="comment">	 * 给floor_freq赋值freq_table中最小的频率</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	cpufreq_cdev-&gt;clipped_freq = cpufreq_cdev-&gt;freq_table[<span class="number">0</span>].frequency;</span><br><span class="line">	cpufreq_cdev-&gt;floor_freq =</span><br><span class="line">		cpufreq_cdev-&gt;freq_table[cpufreq_cdev-&gt;max_level].frequency;</span><br><span class="line">	cpufreq_cdev-&gt;cpufreq_floor_state = cpufreq_cdev-&gt;max_level;</span><br><span class="line">	cpufreq_cdev-&gt;cdev = cdev;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Register the notifier for first cpufreq cooling device */</span></span><br><span class="line">	first = list_empty(&amp;cpufreq_cdev_list);</span><br><span class="line">	list_add(&amp;cpufreq_cdev-&gt;node, &amp;cpufreq_cdev_list);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 注册事件通知链 cpufreq_policy_notifier_list ，其中回调函数为</span></span><br><span class="line"><span class="comment">	 * thermal_cpufreq_notifier_block</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (first &amp;&amp; !cpufreq_cdev-&gt;plat_ops)</span><br><span class="line">		cpufreq_register_notifier(&amp;thermal_cpufreq_notifier_block,</span><br><span class="line">					  CPUFREQ_POLICY_NOTIFIER);</span><br><span class="line">    	---&gt;blocking_notifier_chain_register(</span><br><span class="line">				&amp;cpufreq_policy_notifier_list, nb);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 1.注册事件通知链 pm_chain_head ，其中回调函数为 cpufreq_cooling_pm_nb</span></span><br><span class="line"><span class="comment">	 * 2.初始化cpuhp_register_work工作队列，并立即调度</span></span><br><span class="line"><span class="comment">	 * ---&gt;该工作队列主要目的为设置cpu hotplug状态的回调函数</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!cpuhp_registered) &#123;</span><br><span class="line">		cpuhp_registered = <span class="number">1</span>;</span><br><span class="line">		register_pm_notifier(&amp;cpufreq_cooling_pm_nb);</span><br><span class="line">		INIT_WORK(&amp;cpuhp_register_work, register_cdev);</span><br><span class="line">		queue_work(system_wq, &amp;cpuhp_register_work);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cdev;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>可以看到，注册cpufreq thermal cooling device的流程和backlight基本一致，只是要执行最终对应的动作时，2者使用的函数集不同，cpufreq对应cpufreq_cooling_ops，而backlight对应bd_cdev_ops。</p>
<p>注意点：<br>关于cooling device的dts中cooling-device属性的格式如下：<br>cooling-device =&lt;&amp;<mitigation_device> <perf_ceiling> <perf_floor>&gt;;</perf_floor></perf_ceiling></mitigation_device></p>
<ul>
<li>perf_ceiling parameter is the highest allowable performance level (that is, the ceiling)</li>
<li>perf_floor is the lowest allowable performance level (that is, the floor)</li>
<li>In either case, a lower index means less mitigation and higher index means deeper mitigation; there can be<br>multiple of these levels depending on rule</li>
<li>perf_ceiling value should always be &lt;= to perf_floor</li>
</ul>
<p>其中perf_ceiling和perf_floor有2种填写类型：</p>
<ol>
<li><p>使用THERMAL_MAX_LIMIT宏，即使用相对值的方式：<br>cooling-device = &lt;&amp;CPU7 (THERMAL_MAX_LIMIT-5) (THERMAL_MAX_LIMIT-2)&gt;;<br>这里假设 cooling device的min_state为0，max_state为8，那么上面的dts的等效为<br>cooling-device = &lt;&amp;CPU7 3 6&gt;;</p>
</li>
<li><p>直接使用绝对值的方式：<br>cooling-device = &lt;&amp;modem_vdd 0 0&gt;;<br>相关详细代码可以参见如下逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* kernel/msm-4.14/drivers/thermal/thermal_core.c */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If upper or lower has a MACRO to define the mitigation state,</span></span><br><span class="line"><span class="comment">	 * based on the MACRO determine the default state to use or the</span></span><br><span class="line"><span class="comment">	 * offset from the max_state.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (upper &gt;= (THERMAL_MAX_LIMIT - max_state)) &#123;</span><br><span class="line">		<span class="comment">/* upper default max_state */</span></span><br><span class="line">		<span class="keyword">if</span> (upper == THERMAL_NO_LIMIT)</span><br><span class="line">			upper = max_state;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			upper = max_state - (THERMAL_MAX_LIMIT - upper);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (lower &gt;= (THERMAL_MAX_LIMIT - max_state)) &#123;</span><br><span class="line">		<span class="comment">/* lower default 0 */</span></span><br><span class="line">		<span class="keyword">if</span> (lower == THERMAL_NO_LIMIT)</span><br><span class="line">			lower = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			lower =  max_state - (THERMAL_MAX_LIMIT - lower);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h2 id="Thermal-Governor"><a href="#Thermal-Governor" class="headerlink" title="Thermal Governor"></a>Thermal Governor</h2><p>Thermal Governor作为框架中的降温策略，主要的Governor如下，我们一一介绍</p>
<ul>
<li>user space</li>
<li>step wise</li>
<li>low_limits_floor 和 low_limits_cap</li>
</ul>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h3 id="user-space"><a href="#user-space" class="headerlink" title="user space"></a>user space</h3><p>user space算法非常简单，当相关温度触发该机制时，调用notify_user_space函数，使用uevent机制来通知thermal-engine，关于thermal-engine具体怎么接受及使用kernel发送的信息，等后面thermal-engine的章节再介绍。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * notify_user_space - Notifies user space about thermal events</span></span><br><span class="line"><span class="comment"> * @tz - thermal_zone_device</span></span><br><span class="line"><span class="comment"> * @trip - trip point index</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function notifies the user space through UEvents.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">notify_user_space</span><span class="params">(struct thermal_zone_device *tz, <span class="keyword">int</span> trip)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *thermal_prop[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">	thermal_prop[<span class="number">0</span>] = kasprintf(GFP_KERNEL, <span class="string">&quot;NAME=%s&quot;</span>, tz-&gt;type);</span><br><span class="line">	thermal_prop[<span class="number">1</span>] = kasprintf(GFP_KERNEL, <span class="string">&quot;TEMP=%d&quot;</span>, tz-&gt;temperature);</span><br><span class="line">	thermal_prop[<span class="number">2</span>] = kasprintf(GFP_KERNEL, <span class="string">&quot;TRIP=%d&quot;</span>, trip);</span><br><span class="line">	thermal_prop[<span class="number">3</span>] = kasprintf(GFP_KERNEL, <span class="string">&quot;EVENT=%d&quot;</span>, tz-&gt;notify_event);</span><br><span class="line">	thermal_prop[<span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 发送uevent事件给thermal-engine服务</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	kobject_uevent_env(&amp;tz-&gt;device.kobj, KOBJ_CHANGE, thermal_prop);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">thermal_governor</span> <span class="title">thermal_gov_user_space</span> = &#123;</span></span><br><span class="line">	.name		= <span class="string">&quot;user_space&quot;</span>,</span><br><span class="line">	.throttle	= notify_user_space,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">thermal_gov_user_space_register</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> thermal_register_governor(&amp;thermal_gov_user_space);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h3 id="step-wise"><a href="#step-wise" class="headerlink" title="step wise"></a>step wise</h3><p>step wise 策略根据当前温度和温度的趋势来动态调节温度制御等级，多用于cpu，gpu频率等级的动态调节，其策略的实现逻辑如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">step_wise_throttle</span><span class="params">(struct thermal_zone_device *tz, <span class="keyword">int</span> trip)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_instance</span> *<span class="title">instance</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 主要作用是通过温度趋势来决定instance-&gt;target</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	thermal_zone_trip_update(tz, trip);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 根据如下2个值来最终决定cooling device的当前状态</span></span><br><span class="line"><span class="comment">	 * cdev-&gt;sysfs_cur_state_req</span></span><br><span class="line"><span class="comment">	 * instance-&gt;target</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	list_for_each_entry(instance, &amp;tz-&gt;thermal_instances, tz_node)</span><br><span class="line">		thermal_cdev_update(instance-&gt;cdev);</span><br><span class="line">		---&gt;<span class="comment">//设置cooling devices为目标状态</span></span><br><span class="line">			cdev-&gt;ops-&gt;set_cur_state(cdev, current_target);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">thermal_governor</span> <span class="title">thermal_gov_step_wise</span> = &#123;</span></span><br><span class="line">	.name		= <span class="string">&quot;step_wise&quot;</span>,</span><br><span class="line">	.throttle	= step_wise_throttle,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">thermal_gov_step_wise_register</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> thermal_register_governor(&amp;thermal_gov_step_wise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>其中step wise策略核心思想是由thermal_zone_trip_update实现的，主要内容如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">thermal_zone_trip_update</span><span class="params">(struct thermal_zone_device *tz, <span class="keyword">int</span> trip)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> trip_temp, hyst_temp;</span><br><span class="line">	<span class="keyword">enum</span> thermal_trip_type trip_type;</span><br><span class="line">	<span class="keyword">enum</span> thermal_trend trend;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_instance</span> *<span class="title">instance</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> throttle = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> old_target;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 获取therma zone 的tirp 温度和hyst温度</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (trip == THERMAL_TRIPS_NONE) &#123;</span><br><span class="line">		hyst_temp = trip_temp = tz-&gt;forced_passive;</span><br><span class="line">		trip_type = THERMAL_TRIPS_NONE;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		tz-&gt;ops-&gt;get_trip_temp(tz, trip, &amp;trip_temp);</span><br><span class="line">		<span class="keyword">if</span> (tz-&gt;ops-&gt;get_trip_hyst) &#123;</span><br><span class="line">			tz-&gt;ops-&gt;get_trip_hyst(tz, trip, &amp;hyst_temp);</span><br><span class="line">			hyst_temp = trip_temp - hyst_temp;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			hyst_temp = trip_temp;</span><br><span class="line">		&#125;</span><br><span class="line">		tz-&gt;ops-&gt;get_trip_type(tz, trip, &amp;trip_type);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 获取当前的温度趋势，trend结果如下</span></span><br><span class="line"><span class="comment">	 * THERMAL_TREND_RAISING:温度上升</span></span><br><span class="line"><span class="comment">	 * THERMAL_TREND_DROPPING:温度下降</span></span><br><span class="line"><span class="comment">	 * THERMAL_TREND_STABLE:温度平稳</span></span><br><span class="line"><span class="comment">	 * THERMAL_TREND_RAISE_FULL:应用最高等级的温度制御动作</span></span><br><span class="line"><span class="comment">	 * THERMAL_TREND_DROP_FULL：应用最低等级的温度制御动作</span></span><br><span class="line"><span class="comment">	 * 最后2种状态在当前kernel-4.19版本中并没有涉及。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	trend = get_tz_trend(tz, trip);</span><br><span class="line"></span><br><span class="line">	list_for_each_entry(instance, &amp;tz-&gt;thermal_instances, tz_node) &#123;</span><br><span class="line">		<span class="keyword">if</span> (instance-&gt;trip != trip)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		old_target = instance-&gt;target;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Step wise has to lower the mitigation only if the</span></span><br><span class="line"><span class="comment">		 * temperature goes below the hysteresis temperature.</span></span><br><span class="line"><span class="comment">		 * Atleast, it has to hold on to mitigation device lower</span></span><br><span class="line"><span class="comment">		 * limit if the temperature is above the hysteresis</span></span><br><span class="line"><span class="comment">		 * temperature.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (tz-&gt;temperature &gt;= trip_temp ||</span><br><span class="line">			(tz-&gt;temperature &gt; hyst_temp &amp;&amp;</span><br><span class="line">			 old_target != THERMAL_NO_TARGET))</span><br><span class="line">			throttle = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			throttle = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * 如果温度高于触发温度</span></span><br><span class="line"><span class="comment">		 *    a. 温度趋势为 THERMAL_TREND_RAISING</span></span><br><span class="line"><span class="comment">		 *    ---&gt;提升温度制御动作</span></span><br><span class="line"><span class="comment">		 *    b. 温度趋势 THERMAL_TREND_DROPPING</span></span><br><span class="line"><span class="comment">		 *    ---&gt;不处理</span></span><br><span class="line"><span class="comment">		 *    c. 温度趋势 THERMAL_TREND_RAISE_FULL</span></span><br><span class="line"><span class="comment">         *    ---&gt;使用最高等级的温度制御动作</span></span><br><span class="line"><span class="comment">		 *    a. 温度趋势为 THERMAL_TREND_DROP_FULL</span></span><br><span class="line"><span class="comment">		 *    ---&gt;使用最低等级的温度制御动作</span></span><br><span class="line"><span class="comment">		 *    </span></span><br><span class="line"><span class="comment">		 * 如果温度低于触发温度</span></span><br><span class="line"><span class="comment">		 *    a. 温度趋势为 THERMAL_TREND_RAISING</span></span><br><span class="line"><span class="comment">		 *    ---&gt;不处理</span></span><br><span class="line"><span class="comment">		 *    b. 温度趋势 THERMAL_TREND_DROPPING</span></span><br><span class="line"><span class="comment">		 *    ---&gt;降低温度制御等级，</span></span><br><span class="line"><span class="comment">		 *    ---&gt;如果已经为最低温度制御等级，停止thermal instance策略</span></span><br><span class="line"><span class="comment">		 *    c. 温度趋势 THERMAL_TREND_RAISE_FULL</span></span><br><span class="line"><span class="comment">         *    ---&gt;不处理</span></span><br><span class="line"><span class="comment">		 *    a. 温度趋势为 THERMAL_TREND_DROP_FULL</span></span><br><span class="line"><span class="comment">		 *    ---&gt;使用最低等级的温度制御动作</span></span><br><span class="line"><span class="comment">		 *    ---&gt;如果已经为最低等级温度制御等级，停止thermal instance策略</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">		instance-&gt;target = get_target_state(instance, trend, throttle);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * 初始化完成，并且温度制御目标等级未发生变化，跳过</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (instance-&gt;initialized &amp;&amp; old_target == instance-&gt;target)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * 根据instance-&gt;target来更新tz-&gt;passive的值</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (!instance-&gt;initialized) &#123;</span><br><span class="line">			<span class="keyword">if</span> (instance-&gt;target != THERMAL_NO_TARGET) &#123;</span><br><span class="line">				trace_thermal_zone_trip(tz, trip, trip_type,</span><br><span class="line">							<span class="literal">true</span>);</span><br><span class="line">				update_passive_instance(tz, trip_type, <span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* Activate a passive thermal instance */</span></span><br><span class="line">			<span class="keyword">if</span> (old_target == THERMAL_NO_TARGET &amp;&amp;</span><br><span class="line">				instance-&gt;target != THERMAL_NO_TARGET) &#123;</span><br><span class="line">				trace_thermal_zone_trip(tz, trip, trip_type,</span><br><span class="line">							<span class="literal">true</span>);</span><br><span class="line">				update_passive_instance(tz, trip_type, <span class="number">1</span>);</span><br><span class="line">			<span class="comment">/* Deactivate a passive thermal instance */</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (old_target != THERMAL_NO_TARGET &amp;&amp;</span><br><span class="line">				instance-&gt;target == THERMAL_NO_TARGET) &#123;</span><br><span class="line">				trace_thermal_zone_trip(tz, trip, trip_type,</span><br><span class="line">							<span class="literal">false</span>);</span><br><span class="line">				update_passive_instance(tz, trip_type, <span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		instance-&gt;initialized = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">		instance-&gt;cdev-&gt;updated = <span class="literal">false</span>; <span class="comment">/* cdev needs update */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;tz-&gt;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>step wise机制的逻辑框图大致如下：<br><img src="/2021/01/05/Thermal_Core_Framework_Architecture/step_wise.PNG" alt="step wise机制"></p>
<p>如果dts中某个实例的cooling-device属性中的perf_ceiling与perf_floor相等时，当触发实例时，该算法直接设置相关cooling devices的等级为定值，不进行动态变化。</p>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h3 id="low-limits-floor-和-low-limits-cap"><a href="#low-limits-floor-和-low-limits-cap" class="headerlink" title="low_limits_floor 和 low_limits_cap"></a>low_limits_floor 和 low_limits_cap</h3><ul>
<li>low_limits_floor handles VDD restriction by placing a perf floor on cooling device</li>
<li>low_limits_cap handles SOC and VBat conditions by placing a perf ceiling on cooling device</li>
</ul>
<p>low_limits_floor 和 low_limits_cap 为一类别算法，在如下代码中可以看出，low_limits_floor 相关结构体只是多了”.min_state_throttle = 1”一行代码，导致他们的处理逻辑不一致。</p>
<ul>
<li>low_limits_floor 当检测到thermal zone温度低于触发温度时,将instance-&gt;target设置为最高cooling device制御级别，如果该值小于cdev-&gt;sysfs_min_state_req（这里的min state对应cooling device的最高制御），则重新设置cooling device的最高温度制御状态，即 cooling the device floor state为当前instance-&gt;target的值。</li>
<li>low_limits_cap 当检测到thermal zone温度低于触发温度时,将instance-&gt;target设置为最高cooling device制御级别，如果该值大于当前的cooling device等级，则设置当前温度制御等级的值为instance-&gt;target的值。<br>详细代码流程如下：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">low_limits_throttle</span><span class="params">(struct thermal_zone_device *tz, <span class="keyword">int</span> trip)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_instance</span> *<span class="title">instance</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 主要作用是通过温度是否低于触发温度来决定instance-&gt;target</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	thermal_zone_trip_update(tz, trip);</span><br><span class="line"></span><br><span class="line">	list_for_each_entry(instance, &amp;tz-&gt;thermal_instances, tz_node)</span><br><span class="line">		thermal_cdev_update(instance-&gt;cdev);</span><br><span class="line">		---&gt;<span class="comment">//low_limits_floor算法，替换cooling device 的floor state</span></span><br><span class="line">			cdev-&gt;ops-&gt;set_min_state(cdev, min_target);</span><br><span class="line">		[<span class="keyword">or</span>]</span><br><span class="line">		---&gt;<span class="comment">//low_limits_cap算法,替换cooling device的ceiling state</span></span><br><span class="line">			cdev-&gt;ops-&gt;set_cur_state(cdev, current_target);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">thermal_governor</span> <span class="title">thermal_gov_low_limits_floor</span> = &#123;</span></span><br><span class="line">	.name		= <span class="string">&quot;low_limits_floor&quot;</span>,</span><br><span class="line">	.throttle	= low_limits_throttle,</span><br><span class="line">	.min_state_throttle = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">thermal_governor</span> <span class="title">thermal_gov_low_limits_cap</span> = &#123;</span></span><br><span class="line">	.name		= <span class="string">&quot;low_limits_cap&quot;</span>,</span><br><span class="line">	.throttle	= low_limits_throttle,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">thermal_zone_trip_update</span><span class="params">(struct thermal_zone_device *tz, <span class="keyword">int</span> trip)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> trip_temp, trip_hyst;</span><br><span class="line">	<span class="keyword">enum</span> thermal_trip_type trip_type;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thermal_instance</span> *<span class="title">instance</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> throttle;</span><br><span class="line">	<span class="keyword">int</span> old_target;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 获取therma zone 的tirp 温度和hyst温度</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	tz-&gt;ops-&gt;get_trip_temp(tz, trip, &amp;trip_temp);</span><br><span class="line">	tz-&gt;ops-&gt;get_trip_type(tz, trip, &amp;trip_type);</span><br><span class="line">	<span class="keyword">if</span> (tz-&gt;ops-&gt;get_trip_hyst) &#123;</span><br><span class="line">		tz-&gt;ops-&gt;get_trip_hyst(tz, trip, &amp;trip_hyst);</span><br><span class="line">		trip_hyst = trip_temp + trip_hyst;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		trip_hyst = trip_temp;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;tz-&gt;lock);</span><br><span class="line"></span><br><span class="line">	list_for_each_entry(instance, &amp;tz-&gt;thermal_instances, tz_node) &#123;</span><br><span class="line">		<span class="keyword">if</span> (instance-&gt;trip != trip)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 	 * 获取therma zone 温度低于触发温度时，设置throttle为true</span></span><br><span class="line"><span class="comment">	 	 * 同时设置instance-&gt;target为最高制御等级限制行为</span></span><br><span class="line"><span class="comment">	 	 */</span></span><br><span class="line">		<span class="keyword">if</span> ((tz-&gt;temperature &lt;= trip_temp) ||</span><br><span class="line">			(instance-&gt;target != THERMAL_NO_TARGET</span><br><span class="line">				&amp;&amp; tz-&gt;temperature &lt; trip_hyst))</span><br><span class="line">			throttle = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			throttle = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		old_target = instance-&gt;target;</span><br><span class="line">		instance-&gt;target = (throttle) ? instance-&gt;upper</span><br><span class="line">					: THERMAL_NO_TARGET;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (instance-&gt;initialized &amp;&amp; old_target == instance-&gt;target)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * 根据instance-&gt;target来更新tz-&gt;passive的值</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (!instance-&gt;initialized) &#123;</span><br><span class="line">			<span class="keyword">if</span> (instance-&gt;target != THERMAL_NO_TARGET) &#123;</span><br><span class="line">				trace_thermal_zone_trip(tz, trip, trip_type,</span><br><span class="line">							<span class="literal">true</span>);</span><br><span class="line">				tz-&gt;passive += <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (old_target == THERMAL_NO_TARGET &amp;&amp;</span><br><span class="line">				instance-&gt;target != THERMAL_NO_TARGET) &#123;</span><br><span class="line">				trace_thermal_zone_trip(tz, trip, trip_type,</span><br><span class="line">							<span class="literal">true</span>);</span><br><span class="line">				tz-&gt;passive += <span class="number">1</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (old_target != THERMAL_NO_TARGET &amp;&amp;</span><br><span class="line">				instance-&gt;target == THERMAL_NO_TARGET) &#123;</span><br><span class="line">				trace_thermal_zone_trip(tz, trip, trip_type,</span><br><span class="line">							<span class="literal">false</span>);</span><br><span class="line">				tz-&gt;passive -= <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		instance-&gt;initialized = <span class="literal">true</span>;</span><br><span class="line">		instance-&gt;cdev-&gt;updated = <span class="literal">false</span>; <span class="comment">/* cdev needs update */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;tz-&gt;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>算法代码流程如上，比较简单，我们这里用 CPU 和 BCL 来举例说明low_limits_floor 和 low_limits_cap的具体流程。</p>
<p>CPU 示例：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cpu<span class="number">-1</span><span class="number">-0</span>-lowf &#123;</span><br><span class="line">		polling-delay-passive = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">		polling-delay = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">		thermal-governor = <span class="string">&quot;low_limits_floor&quot;</span>;</span><br><span class="line">		thermal-sensors = &lt;&amp;tsens0 <span class="number">9</span>&gt;;</span><br><span class="line">		wake-capable-sensor;</span><br><span class="line">		tracks-low;</span><br><span class="line">		trips &#123;</span><br><span class="line">			cpu4_lowf_trip: cpu4-lowf-trip &#123;</span><br><span class="line">				temperature = &lt;<span class="number">5000</span>&gt;;</span><br><span class="line">				hysteresis = &lt;<span class="number">5000</span>&gt;;</span><br><span class="line">				type = <span class="string">&quot;passive&quot;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">		cooling-maps &#123;</span><br><span class="line">			cpu0_cdev &#123;</span><br><span class="line">				trip = &lt;&amp;cpu4_lowf_trip&gt;;</span><br><span class="line">				cooling-device = &lt;&amp;CPU0 (THERMAL_MAX_LIMIT<span class="number">-5</span>)</span><br><span class="line">							(THERMAL_MAX_LIMIT<span class="number">-5</span>)&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line">			</span><br><span class="line">            cpu7_cdev &#123;</span><br><span class="line">				trip = &lt;&amp;cpu4_lowf_trip&gt;;</span><br><span class="line">				cooling-device = &lt;&amp;CPU7 (THERMAL_MAX_LIMIT<span class="number">-5</span>)</span><br><span class="line">							(THERMAL_MAX_LIMIT<span class="number">-5</span>)&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">		&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>此段dts的目的为</p>
<ol>
<li>注册一个名字为 cpu-1-0-lowf 的thermal zone</li>
<li>此thermal zone没有使用轮询方式，而是 type为 passive 来主动进行温度制御</li>
<li>算法使用low_limits_floor</li>
<li>使用的cpu内部tsens0 id为9的sensor</li>
<li>设置温度触发点为5摄氏度，滞后值也为5摄氏度</li>
<li>假设该平台，CPU max state为8，min state为0，当sensor温度低于5摄氏度时，查看当前的cdev-&gt;sysfs_min_state_req（这里的min state对应cooling device的最高制御），如果【max_state - (THERMAL_MAX_LIMIT - lower) = 3】小于cdev-&gt;sysfs_min_state_req，则重新设置cooling dev的floor state 为3。主要作用为低温时，减少对CPU频率上限的限制。</li>
</ol>
<p>BCL battery voltage控制示例<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pmi632-vbat-lvl0 &#123;</span><br><span class="line">	polling-delay-passive = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">	polling-delay = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">	thermal-governor = <span class="string">&quot;low_limits_cap&quot;</span>;</span><br><span class="line">	thermal-sensors = &lt;&amp;bcl_sensor <span class="number">2</span>&gt;;</span><br><span class="line">	wake-capable-sensor;</span><br><span class="line">	tracks-low;</span><br><span class="line"></span><br><span class="line">	trips &#123;</span><br><span class="line">		pmi632_vbat_lvl0: vbat-lvl0 &#123;</span><br><span class="line">			temperature = &lt;<span class="number">3000</span>&gt;;</span><br><span class="line">			hysteresis = &lt;<span class="number">100</span>&gt;;</span><br><span class="line">			type = <span class="string">&quot;passive&quot;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>此段dts的目的为</p>
<ol>
<li>注册一个名字为 pmi632-vbat-lvl0的thermal zone</li>
<li>此thermal zone没有使用轮询方式，而是 type为 passive 来主动进行温度制御</li>
<li>算法使用 low_limits_cap</li>
<li>使用的bcl_sensor id为2的sensor，虚构的sensor，实际是读取的电压值，单位为mV</li>
<li>设置sensor触发值为3v，滞后值为0.1v</li>
<li>当sensor值低于3v时，触发某些动作，由于此平台默认没有动作，所以没有cooling-maps部分，我们可以根据实际项目情况添加。</li>
</ol>
<p>BCL battery soc控制示例<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">soc &#123;</span><br><span class="line">	polling-delay-passive = &lt;<span class="number">100</span>&gt;;</span><br><span class="line">	polling-delay = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">	thermal-governor = <span class="string">&quot;low_limits_cap&quot;</span>;</span><br><span class="line">	thermal-sensors = &lt;&amp;bcl_soc&gt;;</span><br><span class="line">	wake-capable-sensor;</span><br><span class="line">	tracks-low;</span><br><span class="line"></span><br><span class="line">	trips &#123;</span><br><span class="line">		pmi632_low_soc: low-soc &#123;</span><br><span class="line">			temperature = &lt;<span class="number">10</span>&gt;;</span><br><span class="line">			hysteresis = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">			type = <span class="string">&quot;passive&quot;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">	cooling-maps &#123;</span><br><span class="line">		soc_cpu0 &#123;</span><br><span class="line">			trip = &lt;&amp;pmi632_low_soc&gt;;</span><br><span class="line">			cooling-device =</span><br><span class="line">				&lt;&amp;CPU0 (THERMAL_MAX_LIMIT<span class="number">-5</span>)</span><br><span class="line">					(THERMAL_MAX_LIMIT<span class="number">-5</span>)&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">		soc_cpu7 &#123;</span><br><span class="line">			trip = &lt;&amp;pmi632_low_soc&gt;;</span><br><span class="line">			cooling-device =</span><br><span class="line">				&lt;&amp;CPU7 THERMAL_MAX_LIMIT</span><br><span class="line">					THERMAL_MAX_LIMIT&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>此段dts的目的为</p>
<ol>
<li>注册一个名字为 soc 的thermal zone</li>
<li>此thermal zone没有使用轮询方式，而是 type为 passive 来主动进行温度制御</li>
<li>算法使用 low_limits_cap</li>
<li>使用的bcl_soc sensor，虚构的sensor，实际是读取电池容量百分比</li>
<li>设置sensor触发值为10%，无滞后值</li>
<li>当sensor值低于10%时，设置CPU0的cooling state为3（假设max = 8，min = 0），同时设置CPU7的cooling state为8，即hotplug该cpu。</li>
</ol>
<p>除了step wise,userspace,low_limits_floor 和 low_limits_cap算法在高通Android系统有经常使用到，<br>thermal governor还包括了power_allocator，bang_bang，fair_share算法，但是从目前高通Android代码看，基本没有使用到，所以这里就不做介绍了。</p>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h2 id="Thermal-Core总结"><a href="#Thermal-Core总结" class="headerlink" title="Thermal Core总结"></a>Thermal Core总结</h2><p>以使用backlight来控制亮度，step wise算法来控制温度为例，相关时序图如下：<br><img src="/2021/01/05/Thermal_Core_Framework_Architecture/Thermal_core.png" alt="Thermal Core 时序图"></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Thermal/" rel="tag"># Thermal</a>
          </div>
          <script type="text/javascript">
            var tagsall=document.getElementsByClassName("post-tags")
            for (var i = tagsall.length - 1; i >= 0; i--){
                var tags=tagsall[i].getElementsByTagName("a");
                for (var j = tags.length - 1; j >= 0; j--) {
                    var r=Math.floor(Math.random()*75+130);
                    var g=Math.floor(Math.random()*75+100);
                    var b=Math.floor(Math.random()*75+80);
                    tags[j].style.background = "rgb("+r+","+g+","+b+")";
                }
            }                        
            </script>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/09/24/Qcom-platform-battery-capacity-algorithm/" rel="prev" title="Qcom platform battery capacity algorithm">
      <i class="fa fa-chevron-left"></i> Qcom platform battery capacity algorithm
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/03/20/Android-USB-Framework-Architecture/" rel="next" title="Android_USB_Framework_Architecture">
      Android_USB_Framework_Architecture <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Thermal-Zone-Device"><span class="nav-number">1.</span> <span class="nav-text">Thermal Zone Device</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thermal-Core"><span class="nav-number">2.</span> <span class="nav-text">Thermal Core</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thermal-Cooling-Device"><span class="nav-number">3.</span> <span class="nav-text">Thermal Cooling Device</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#backlight%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.1.</span> <span class="nav-text">backlight示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cpufreq%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.2.</span> <span class="nav-text">cpufreq示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thermal-Governor"><span class="nav-number">4.</span> <span class="nav-text">Thermal Governor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#user-space"><span class="nav-number">4.1.</span> <span class="nav-text">user space</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#step-wise"><span class="nav-number">4.2.</span> <span class="nav-text">step wise</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#low-limits-floor-%E5%92%8C-low-limits-cap"><span class="nav-number">4.3.</span> <span class="nav-text">low_limits_floor 和 low_limits_cap</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thermal-Core%E6%80%BB%E7%BB%93"><span class="nav-number">5.</span> <span class="nav-text">Thermal Core总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LexYoung</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LexYoung</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
